# 엘라스틱서치(Elasticsearch) 파이썬으로 데이터 조회 및 등록 방법

## 1. 기본 설정

### 필요한 패키지 설치
```bash
pip install elasticsearch
```

### 기본 연결 설정 (로그인 정보 포함)
```python
from elasticsearch import Elasticsearch

# 기본 연결 (로그인 정보 포함)
es = Elasticsearch(
    hosts=["http://localhost:9200"],  # 엘라스틱서치 서버 주소
    http_auth=('username', 'password'),  # 로그인 정보 (사용자명, 비밀번호)
    verify_certs=False  # SSL 인증서 검증 생략 (개발 환경에서만 사용)
)

# 연결 테스트
if es.ping():
    print("연결 성공")
else:
    print("연결 실패")
```

## 2. 데이터 등록 (인덱싱)

### 단일 문서 등록
```python
doc = {
    "author": "kim",
    "text": "엘라스틱서치 파이썬 클라이언트 테스트",
    "timestamp": "2023-11-20T10:00:00",
    "tags": ["python", "elasticsearch"]
}

# 인덱스에 문서 추가 (my_index는 인덱스 이름, id는 생략 가능)
res = es.index(index="my_index", id=1, document=doc)
print(res['result'])  # 결과: created (새로 생성) 또는 updated (업데이트)
```

### 여러 문서 일괄 등록 (Bulk API)
```python
from elasticsearch.helpers import bulk

actions = [
    {
        "_index": "my_index",
        "_source": {
            "author": "lee",
            "text": "첫 번째 문서",
            "timestamp": "2023-11-20T11:00:00"
        }
    },
    {
        "_index": "my_index",
        "_source": {
            "author": "park",
            "text": "두 번째 문서",
            "timestamp": "2023-11-20T12:00:00"
        }
    }
]

# 벌크 연산 수행
success, _ = bulk(es, actions)
print(f"{success}개 문서 등록 성공")
```

## 3. 데이터 조회

### 단일 문서 조회
```python
# 문서 ID로 조회
res = es.get(index="my_index", id=1)
print(res['_source'])
```

### 검색 쿼리 사용
```python
# 기본 검색
query = {
    "query": {
        "match": {
            "author": "kim"
        }
    }
}

res = es.search(index="my_index", body=query)
print(f"총 {res['hits']['total']['value']}개 문서 발견")

for hit in res['hits']['hits']:
    print(f"점수: {hit['_score']}, 문서: {hit['_source']}")
```

### 복합 검색 쿼리 예제
```python
complex_query = {
    "query": {
        "bool": {
            "must": [
                {"match": {"author": "kim"}}
            ],
            "filter": [
                {"range": {"timestamp": {"gte": "2023-11-01"}}}
            ]
        }
    },
    "sort": [
        {"timestamp": {"order": "desc"}}
    ],
    "size": 5  # 최대 5개 문서 반환
}

res = es.search(index="my_index", body=complex_query)
```

## 4. 고급 설정

### SSL/TLS를 사용한 보안 연결
```python
from ssl import create_default_context

context = create_default_context(cafile="path/to/certificate.pem")

es = Elasticsearch(
    hosts=["https://localhost:9200"],
    http_auth=('username', 'password'),
    ssl_context=context,
    verify_certs=True
)
```

### API 키를 사용한 인증
```python
es = Elasticsearch(
    hosts=["http://localhost:9200"],
    api_key=('api_key_id', 'api_key_secret')
)
```

## 5. 추가 기능

### 인덱스 생성 및 설정
```python
index_settings = {
    "settings": {
        "number_of_shards": 1,
        "number_of_replicas": 0
    },
    "mappings": {
        "properties": {
            "author": {"type": "keyword"},
            "text": {"type": "text"},
            "timestamp": {"type": "date"},
            "tags": {"type": "keyword"}
        }
    }
}

if not es.indices.exists(index="my_index"):
    es.indices.create(index="my_index", body=index_settings)
```

### 인덱스 삭제
```python
if es.indices.exists(index="my_index"):
    es.indices.delete(index="my_index")
```

## 주의사항
1. 실제 운영 환경에서는 `verify_certs=False`를 사용하지 마세요.
2. 민감한 로그인 정보는 환경 변수나 설정 파일로 분리하는 것이 좋습니다.
3. 대량의 데이터를 처리할 때는 벌크 API를 사용하세요.
4. 엘라스틱서치 버전에 따라 API가 약간 다를 수 있습니다.

이 코드들은 엘라스틱서치 7.x 이상 버전을 기준으로 작성되었습니다. 다른 버전을 사용하는 경우 공식 문서를 참조하세요.