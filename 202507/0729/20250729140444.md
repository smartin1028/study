# Java에서 SQL 로그 문자열을 구분하는 라이브러리

Java 애플리케이션에서 로그에 기록된 SQL 문자열을 파싱하고 필터링하기 위해 사용할 수 있는 몇 가지 라이브러리와 접근 방법을 소개합니다.

## 1. 정규 표현식 기반 필터링

가장 기본적인 방법은 정규표현식을 사용하여 SQL 문을 추출하는 것입니다.

```java
import java.util.regex.*;

public class SqlLogParser {
    public static String extractSqlFromLog(String logLine) {
        // 일반적인 SQL 문 패턴 (간단한 예시)
        Pattern pattern = Pattern.compile("(?i)(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP)\\s+.+");
        Matcher matcher = pattern.matcher(logLine);
        
        if (matcher.find()) {
            return matcher.group();
        }
        return null;
    }
}
```

## 2. 전문 로그 파싱 라이브러리

### Logstash Log4j 플러그인
- Logstash는 로그 데이터를 처리하는 강력한 도구이며, Log4j 앱과 연동 가능
- Grok 패턴을 사용하여 SQL 문 추출 가능

### Logback/SLF4J 필터
- 로깅 프레임워크 자체의 필터 기능 활용
```xml
<configuration>
  <appender name="SQL_APPENDER" class="ch.qos.logback.core.FileAppender">
    <file>sql.log</file>
    <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
      <evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
        <expression>message.contains("SELECT") || message.contains("INSERT") 
                   || message.contains("UPDATE") || message.contains("DELETE")</expression>
      </evaluator>
      <OnMatch>ACCEPT</OnMatch>
      <OnMismatch>DENY</OnMismatch>
    </filter>
    <encoder>
      <pattern>%msg%n</pattern>
    </encoder>
  </appender>
</configuration>
```

## 3. SQL 포맷터/파서 라이브러리

### JSqlParser
- SQL 문을 파싱하고 분석할 수 있는 라이브러리
- 로그에서 추출한 SQL 문의 유효성 검사에 사용 가능
```java
import net.sf.jsqlparser.parser.JSqlParser;
import net.sf.jsqlparser.statement.Statement;

public class SqlValidator {
    public static boolean isValidSql(String sql) {
        try {
            Statement statement = JSqlParser.parse(sql);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
```

### Apache Calcite
- SQL 파싱 및 검증 기능 제공

## 4. 로그 전처리 도구

### Log4j2 PatternLayout 사용
```xml
<PatternLayout pattern="%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - SQL: %replace{%msg}{.*?(SELECT|INSERT|UPDATE|DELETE).*}{$1}%n"/>
```

## 5. 커스텀 솔루션 구현 예시

```java
import java.util.Arrays;
import java.util.List;
import java.util.regex.*;

public class AdvancedSqlLogParser {
    private static final List<String> SQL_KEYWORDS = Arrays.asList(
        "SELECT", "INSERT", "UPDATE", "DELETE", "CREATE", "ALTER", "DROP",
        "FROM", "WHERE", "JOIN", "INTO", "VALUES", "SET", "TABLE"
    );
    
    private static final Pattern TIMESTAMP_PATTERN = 
        Pattern.compile("^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{3}");
    
    private static final Pattern COMMENT_PATTERN = 
        Pattern.compile("/\\*.*?\\*/|--.*?$", Pattern.DOTALL | Pattern.MULTILINE);
    
    public static String cleanSqlFromLog(String logLine) {
        // 1. 타임스탬프 제거
        String cleaned = TIMESTAMP_PATTERN.matcher(logLine).replaceFirst("");
        
        // 2. 로그 레벨, 로거 이름 등 제거 (간단한 예시)
        cleaned = cleaned.replaceAll("^\\[?\\w+\\]?", "");
        
        // 3. SQL 주석 제거
        cleaned = COMMENT_PATTERN.matcher(cleaned).replaceAll("");
        
        // 4. SQL 키워드로 시작하는지 확인
        for (String keyword : SQL_KEYWORDS) {
            if (cleaned.trim().toUpperCase().startsWith(keyword)) {
                return cleaned.trim();
            }
        }
        
        return null;
    }
}
```

## 결론

1. 간단한 경우: 정규표현식으로 충분
2. 복잡한 로그 포맷: Logstash Grok 패턴이나 로깅 프레임워크 필터 사용
3. SQL 문 검증 필요: JSqlParser 같은 전문 파서 활용
4. 주석 처리: 정규표현식으로 `/* */`와 `--` 형식의 주석 제거

특히 Hibernate, MyBatis 등 ORM 프레임워크를 사용하는 경우 해당 프레임워크의 로깅 기능을 활용하는 것이 더 효과적일 수 있습니다. 예를 들어 MyBatis는 SQL 문과 파라미터를 별도로 로깅할 수 있는 기능을 제공합니다.

원하는 정확도와 처리해야 할 로그의 복잡도에 따라 적절한 방법을 선택하시면 됩니다.