# Java에서 XML 로그 문자열을 처리하는 라이브러리

Java에서 로그에 기록된 XML 문자열을 추출하고 처리하기 위해 사용할 수 있는 여러 라이브러리가 있습니다. 특히 로그 메시지 앞뒤에 타임스탬프 등의 추가 정보가 있는 경우와 XML 선언문을 처리해야 하는 경우에 적합한 방법을 설명드리겠습니다.

## 1. 주요 라이브러리 및 접근 방법

### 1.1 Jsoup (HTML/XML 파싱)
```java
import org.jsoup.Jsoup;
import org.jsoup.parser.Parser;

public String extractXmlFromLog(String logMessage) {
    // 정규식으로 XML 부분 추출
    String xmlPart = logMessage.replaceAll(".*?(<\\?xml.*?</\\w+>).*", "$1");
    
    // Jsoup으로 XML 파싱 (XML 모드 사용)
    Document doc = Jsoup.parse(xmlPart, "", Parser.xmlParser());
    
    return doc.toString();
}
```

### 1.2 JDOM 또는 DOM4J (전문 XML 처리)
```java
import org.jdom2.Document;
import org.jdom2.input.SAXBuilder;
import org.jdom2.output.Format;
import org.jdom2.output.XMLOutputter;

public String processXmlLog(String logMessage) throws Exception {
    // XML 부분 추출 (간단한 정규식)
    String xmlContent = logMessage.replaceAll(".*?(<\\?xml.*?</\\w+>).*", "$1");
    
    SAXBuilder saxBuilder = new SAXBuilder();
    Document document = saxBuilder.build(new StringReader(xmlContent));
    
    // XML 선언문 추가
    XMLOutputter outputter = new XMLOutputter(Format.getPrettyFormat()
        .setEncoding("UTF-8")
        .setOmitDeclaration(false));
    
    return outputter.outputString(document);
}
```

### 1.3 정규식 기반 추출 (간단한 경우)
```java
public String extractXmlWithDeclaration(String logMessage) {
    // XML 선언문 포함 추출
    Pattern pattern = Pattern.compile("(<\\?xml.*?\\?>.*?</\\w+>)", Pattern.DOTALL);
    Matcher matcher = pattern.matcher(logMessage);
    
    if (matcher.find()) {
        return matcher.group(1);
    }
    return "";
}
```

## 2. 고급 처리 방법 (로그 전용)

### 2.1 Logback/Log4j2의 커스텀 레이아웃
로그 프레임워크 자체에서 XML만 추출하도록 설정할 수 있습니다.

```xml
<!-- Logback 예시 -->
<encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
    <layout class="com.your.package.XmlExtractingLayout"/>
</encoder>
```

### 2.2 Apache Commons Lang + JAXB 조합
```java
import org.apache.commons.lang3.StringUtils;
import javax.xml.bind.JAXB;

public String cleanAndParseXml(String dirtyXml) {
    // XML 시작/종료 태그 찾기
    int start = StringUtils.indexOf(dirtyXml, "<?xml");
    int end = StringUtils.lastIndexOf(dirtyXml, ">");
    
    if (start >= 0 && end > start) {
        String cleanXml = dirtyXml.substring(start, end + 1);
        
        // JAXB로 유효성 검증 (선택적)
        try {
            JAXB.unmarshal(new StringReader(cleanXml), Object.class);
            return cleanXml;
        } catch (Exception e) {
            // 유효하지 않은 XML 처리
        }
    }
    return null;
}
```

## 3. XML 선언문 추가 방법

추출한 XML에 선언문이 없는 경우 추가하는 방법:

```java
public String ensureXmlDeclaration(String xml) {
    if (!xml.trim().startsWith("<?xml")) {
        return "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" + xml;
    }
    return xml;
}
```

## 4. 추천 라이브러리 조합

1. **정규식으로 초기 추출**: `java.util.regex`
2. **XML 파싱 및 유효성 검사**: `org.jsoup` (가벼운 처리) 또는 `JDOM2`/`DOM4J` (강력한 처리)
3. **문자열 조작**: `Apache Commons Lang3`
4. **최종 포맷팅**: `XMLOutputter` (JDOM2) 또는 `Transformer` (javax.xml)

## 5. 주의사항

- 로그 메시지에 여러 XML이 포함된 경우 처리 로직이 복잡해질 수 있음
- CDATA 섹션이 있는 경우 정규식으로 처리하기 어려울 수 있음
- 매우 큰 XML의 경우 SAX 파서 사용을 고려해야 함
- XML 네임스페이스가 있는 경우 파서가 적절히 처리해야 함

이러한 라이브러리와 접근 방법을 조합하면 로그에 포함된 XML 문자열을 효과적으로 추출하고 처리할 수 있습니다.