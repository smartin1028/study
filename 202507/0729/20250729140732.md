# Java에서 로그로 작성된 SQL 문자열 추출 방법

Java 애플리케이션 로그에서 SQL 문과 주석을 추출하는 방법을 설명드리겠습니다. 로그의 시간 정보나 기타 불필요한 내용은 제외하고 SQL 쿼리와 주석만 추출하는 방법입니다.

## 1. 정규식을 이용한 SQL 추출

```java
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class SqlExtractor {
    public static void extractSqlFromLog(String logContent) {
        // SQL 문과 주석을 포함하는 정규식 패턴
        String regex = "(?i)(SELECT|INSERT|UPDATE|DELETE|WITH|CREATE|ALTER|DROP|TRUNCATE|MERGE|CALL|EXECUTE|EXEC|BEGIN|COMMIT|ROLLBACK|SAVEPOINT|--.*|/\\*.*?\\*/)";
        
        Pattern pattern = Pattern.compile(regex, Pattern.DOTALL | Pattern.MULTILINE);
        Matcher matcher = pattern.matcher(logContent);
        
        while (matcher.find()) {
            System.out.println(matcher.group().trim());
        }
    }
    
    public static void main(String[] args) {
        String sampleLog = """
            2023-11-15 12:34:56 INFO  [main] com.example.Dao - Executing SQL: 
            -- 사용자 정보 조회
            SELECT * FROM users WHERE id = ?;
            
            2023-11-15 12:35:01 DEBUG [main] com.example.Dao - Another SQL:
            /* 주석이 포함된 쿼리 */
            UPDATE accounts SET balance = balance - ? WHERE account_id = ?;
            """;
            
        extractSqlFromLog(sampleLog);
    }
}
```

## 2. 더 정교한 SQL 추출 방법

```java
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class AdvancedSqlExtractor {
    public static void extractCompleteSqlStatements(String logContent) {
        // SQL 문 전체와 주석을 추출하는 정규식
        String regex = "(?s)(?i)((--.*?$|/\\*.*?\\*/)\\s*)?(SELECT|INSERT|UPDATE|DELETE|WITH|CREATE|ALTER|DROP|TRUNCATE|MERGE|CALL|EXECUTE|EXEC|BEGIN|COMMIT|ROLLBACK|SAVEPOINT).*?(;|$)";
        
        Pattern pattern = Pattern.compile(regex, Pattern.MULTILINE);
        Matcher matcher = pattern.matcher(logContent);
        
        while (matcher.find()) {
            String fullSql = matcher.group().trim();
            System.out.println("Extracted SQL:");
            System.out.println(fullSql);
            System.out.println("-------------------");
        }
    }
    
    public static void main(String[] args) {
        String complexLog = """
            2023-11-15 12:34:56 INFO  [main] com.example.Dao - Start transaction
            -- 사용자 정보 업데이트
            BEGIN TRANSACTION;
            
            2023-11-15 12:35:00 DEBUG [main] com.example.Dao - Updating user
            /* 멀티라인
            주석 */
            UPDATE users 
            SET last_login = NOW() 
            WHERE user_id = 123;
            
            2023-11-15 12:35:01 INFO  [main] com.example.Dao - Commit
            COMMIT;
            """;
            
        extractCompleteSqlStatements(complexLog);
    }
}
```

## 3. 로그 파일에서 SQL 추출하는 방법

```java
import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class LogFileSqlExtractor {
    public static List<String> extractSqlFromLogFile(String filePath) throws IOException {
        List<String> sqlStatements = new ArrayList<>();
        String regex = "(?s)(?i)((--.*?$|/\\*.*?\\*/)\\s*)?(SELECT|INSERT|UPDATE|DELETE|WITH|CREATE|ALTER|DROP|TRUNCATE|MERGE|CALL|EXECUTE|EXEC|BEGIN|COMMIT|ROLLBACK|SAVEPOINT).*?(;|$)";
        
        try (BufferedReader reader = new BufferedReader(new FileReader(filePath))) {
            StringBuilder logContent = new StringBuilder();
            String line;
            
            while ((line = reader.readLine()) != null) {
                logContent.append(line).append("\n");
            }
            
            Pattern pattern = Pattern.compile(regex, Pattern.MULTILINE);
            Matcher matcher = pattern.matcher(logContent.toString());
            
            while (matcher.find()) {
                sqlStatements.add(matcher.group().trim());
            }
        }
        
        return sqlStatements;
    }
    
    public static void main(String[] args) {
        try {
            List<String> sqls = extractSqlFromLogFile("application.log");
            sqls.forEach(System.out::println);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

## 주의사항

1. 정규식은 복잡한 SQL 문을 완벽히 파싱하지 못할 수 있습니다.
2. 로그 포맷이 변경되면 정규식도 수정해야 할 수 있습니다.
3. 멀티라인 SQL 문을 처리하기 위해 `(?s)` 플래그를 사용했습니다.
4. SQL 주석 형식(`--` 또는 `/* */`)도 함께 추출하도록 설정했습니다.

이 방법들을 사용하면 Java 로그에서 SQL 문과 주석을 효과적으로 추출할 수 있습니다. 필요에 따라 정규식을 조정하여 더 정확하게 추출할 수 있습니다.